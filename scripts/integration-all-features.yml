# Integration Test: All Features Combined
# Demonstrates OAuth2 auth, CSV feeders, multiple protocols, load patterns, and arrival modeling

# Global settings
concurrency: 40
timeout: 15s

# Load patterns: Ramp up, steady state, and spike
load_patterns:
  - name: warmup
    type: ramp
    from_rps: 10
    to_rps: 100
    duration: 2m
  
  - name: steady-state
    type: step
    steps:
      - rps: 100
        duration: 5m
      - rps: 150
        duration: 3m
  
  - name: peak-traffic
    type: spike
    rps: 300
    duration: 30s

# Arrival model: Natural clustering of requests
arrival:
  model: poisson

# OAuth2 authentication
auth:
  type: oauth2_client_credentials
  token_url: https://oauth.example.com/token
  client_id: integration-test-client
  client_secret: test-secret-123
  scopes:
    - api:read
    - api:write
    - api:admin
  refresh_before_expiry: 60s

# CSV data feeder for per-request data injection
feeder:
  path: ./build/sample-users.csv
  type: csv

# Multiple weighted endpoints across different protocols
endpoints:
  # HTTP REST API endpoints
  - name: get-user-profile
    weight: 40
    protocol: http
    url: https://api.example.com/users/{{user_id}}/profile
    method: GET
    headers:
      X-User-Email: "{{email}}"
      X-Request-Source: "loadtest"
  
  - name: update-user
    weight: 20
    protocol: http
    url: https://api.example.com/users/{{user_id}}
    method: PUT
    headers:
      Content-Type: "application/json"
    body: |
      {
        "user_id": "{{user_id}}",
        "email": "{{email}}",
        "updated_at": "{{timestamp}}"
      }
  
  # WebSocket real-time connection
  - name: websocket-chat
    weight: 20
    protocol: websocket
    url: wss://ws.example.com/chat
    websocket:
      messages:
        - '{"action":"authenticate","user_id":"{{user_id}}"}'
        - '{"action":"join","room":"general"}'
        - '{"action":"message","text":"Test message from {{user_id}}"}'
      message_interval: 2s
      receive_timeout: 15s
      handshake_timeout: 30s
  
  # Server-Sent Events stream
  - name: sse-notifications
    weight: 15
    protocol: sse
    url: https://stream.example.com/notifications?user_id={{user_id}}
    sse:
      read_timeout: 45s
      max_events: 100
  
  # gRPC service call
  - name: grpc-user-service
    weight: 5
    protocol: grpc
    target: grpc.example.com:50051
    grpc:
      proto_file: ./api/users.proto
      service: users.UserService
      method: GetUserDetails
      message: |
        {
          "user_id": "{{user_id}}",
          "include_profile": true,
          "include_permissions": true
        }
      timeout: 10s
      tls: true
      insecure: false
      metadata:
        x-user-id: "{{user_id}}"
        x-request-trace: "integration-{{timestamp}}"

# Global headers applied to all HTTP/WebSocket/SSE requests
headers:
  User-Agent: "Crankfire-Integration-Test/1.0"
  X-Environment: "integration"
  X-Test-ID: "all-features-test"
